# üöÄ VoidTracker - Main Walkthrough
**Consolidated Development History & Implementation Guide**

**Last Updated:** 2026-01-12  
**Total Sessions:** 69  
**Project Start:** December 2025

---

## üìã Table of Contents
1. [Project Overview](#project-overview)
2. [Architecture](#architecture)
3. [Major Features by Timeline](#major-features-by-timeline)
4. [Module Implementations](#module-implementations)
5. [Key Technical Decisions](#key-technical-decisions)
6. [Testing & Verification](#testing--verification)

---

## üéØ Project Overview

VoidTracker is an advanced Transportation Management System (TMS) built with modern microservices architecture. The system provides end-to-end logistics management from order intake to final delivery, with AI-powered route optimization.

### Core Capabilities
- **Order Management System (Nexus)** - Order lifecycle management
- **Transport Management (Titan)** - Real-time fleet tracking & geofencing
- **Route Optimization (Flux)** - Timefold-powered VRP solver
- **Driver PWA (Ghost)** - Offline-first mobile interface
- **Control Tower Web UI** - Dispatcher & admin interface
- **IAM Service** - Authentication & authorization
- **Address Registry** - Intelligent address validation & normalization

---

## üèóÔ∏è Architecture

### Module Structure
```
VoidTracker/
‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îú‚îÄ‚îÄ nexus/          # Order Management Service (OMS)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ order-service/
‚îÇ   ‚îú‚îÄ‚îÄ titan/          # Fleet Management
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ danxils-mesh/
‚îÇ   ‚îú‚îÄ‚îÄ flux/           # Planning & Optimization
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ planning-service/
‚îÇ   ‚îú‚îÄ‚îÄ ghost/          # Driver PWA
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ driver-pwa/
‚îÇ   ‚îú‚îÄ‚îÄ iam/            # Identity & Access Management
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ iam-service/
‚îÇ   ‚îî‚îÄ‚îÄ web/            # Control Tower UI
‚îÇ       ‚îî‚îÄ‚îÄ voidtracker-web/
```

### Technology Stack
- **Backend:** Java 21, Spring Boot 3.2+, Hibernate
- **Optimization:** Timefold Solver
- **Frontend:** Vue 3, Vite, Deck.gl, TailwindCSS
- **Database:** PostgreSQL (multi-tenant), Neo4j (graph queries)
- **Messaging:** Apache Kafka
- **Infrastructure:** Docker Compose, Nginx

---

## üìÖ Major Features by Timeline

### **January 2026**

#### Week 2 (Jan 12) - Route Persistence & Assignment Management ‚úÖ
**Session:** `99566e23-c8ea-41d5-b72e-fb12bd4986b6`

**Problem:** Routes generated by Timefold optimizer were ephemeral - stored only in frontend memory and lost on page refresh.

**Implementation:**
1. **UX Improvements**
   - Removed confusing `alt_route` button from Orders view
   - Implemented workflow: Orders ‚Üí Send to Dispatch ‚Üí Select Profile ‚Üí Optimize

2. **Backend Persistence**
   - Created `RouteAssignmentEntity` with JSONB route data storage
   - UUID fields for vehicle/driver/carrier assignment
   - Status lifecycle: DRAFT ‚Üí ASSIGNED ‚Üí PUBLISHED ‚Üí IN_PROGRESS ‚Üí COMPLETED
   - Full CRUD REST API (7 endpoints)
   - Batch creation endpoint for auto-save

3. **Frontend Features**
   - Auto-save routes after optimization
   - "ASSIGNMENTS" tab in DispatchView
   - `AssignmentEditModal.vue` for driver/vehicle assignment
   - Real-time list refresh after operations

**Files Created:**
- `RouteAssignmentEntity.java`
- `RouteAssignmentRepository.java`
- `RouteAssignmentRequestDto.java`, `RouteAssignmentResponseDto.java`
- `RouteAssignmentController.java`
- `AssignmentEditModal.vue`

**API Endpoints:**
- `POST /api/planning/assignments` - Create assignment
- `POST /api/planning/assignments/batch` - Batch create
- `GET /api/planning/assignments` - List all
- `GET /api/planning/assignments/{id}` - Get single
- `PUT /api/planning/assignments/{id}` - Update
- `DELETE /api/planning/assignments/{id}` - Delete
- `POST /api/planning/assignments/{id}/publish` - Publish to driver (generates magic link)

---

#### Week 2 (Jan 11) - Address Registry & Issue Monitoring ‚úÖ
**Session:** `9093af33-ab02-4f5d-b5aa-6cba17993b8c`

**Objective:** Finalize Address Registry enhancements and implement address issues logging system.

**Implementation:**
- Integrated `AddressIssueLoggerService` into `AddressMediatorService`
- Logs address conflicts to dedicated issue tracker
- Integration into `OrderVerificationService` for TES timeouts and normalization failures

---

#### Week 2 (Jan 11) - Frontend Login Debugging ‚úÖ
**Session:** `ce453b97-4d9d-448f-a629-a0c2e8ed5773`

**Problem:** Login hanging due to frontend-IAM connection issues.

**Solution:**
- Fixed Axios configuration (`baseURL` for IAM service)
- Resolved CORS issues
- Verified successful authentication flow

---

### **January 2026 - Week 1**

#### Jan 10 - Infrastructure Debugging ‚úÖ
**Session:** `1edf3562-8ff8-41ee-896c-81f0f6818449`

**Objective:** Resolve critical infrastructure issues preventing E2E testing of Timefold optimizer addons.

**Problems Fixed:**
- Docker image corruption for Kafka, PostgreSQL, Neo4j
- Kafka connectivity issues in `order-service` and `planning-service`
- Service startup failures

**Verification:** Successfully executed `verify_addons.sh` confirming:
1. Elastic Shell Integration ‚úÖ
2. High-Fidelity Dashboard ‚úÖ  
3. Gatekeeper Agent Logic ‚úÖ

---

### **December 2025 - Late**

#### Dec 30 - Database Persistence & Login Fix ‚úÖ
**Session:** `2598fb6b-e1bc-4781-8cea-09ca57e92310`

**Problem:** Database state not persisting across application restarts; persistent login failures (401/502 errors).

**Solution:**
- Decoupled stateful infrastructure (Postgres, Kafka) from application services
- Modified `start-all.sh` and `stop-all.sh` for separate lifecycle management
- Fixed admin user (`cruz`) credentials
- Database reset only on explicit request

---

#### Dec 28 - VoidTracker 2.0 Architecture Definition ‚úÖ
**Session:** `51f6cb31-0276-4111-88be-62860ca79dec`

**Major Milestone:** Complete system architecture documentation

**Modules Defined:**
1. **Nexus (OMS)** - "Static Truth"
   - Order intake, validation, lifecycle management
   - Integration with external systems (TES, BMW EDI)

2. **Titan (TMS)** - "Kinetic Truth"
   - Real-time vehicle tracking
   - Geofencing & ETA calculations
   - Fleet status monitoring

3. **Flux (Optimizer)** - "Intelligence"
   - Timefold VRP solver
   - Constraint-based routing
   - Real-time re-optimization

4. **Ghost (PWA)** - "Interface is Instruction"
   - Offline-first driver app
   - IndexedDB for route sync
   - Magic link authentication

5. **IAM** - Identity & Access Management
   - JWT-based authentication
   - Role-based access control (RBAC)
   - Multi-tenant support

---

### **December 2025 - Mid**

#### Dec 9 - Dispatch Optimization Workflow ‚úÖ
**Session:** `88ebb579-48f5-4120-94f7-269cef9121c6`

**Purpose:** Visual demonstration of complete dispatch optimization workflow.

**Features Demonstrated:**
- Order selection and batch processing
- Timefold optimization execution
- Route visualization with Deck.gl
- Magic link generation for drivers

---

### **December 2025 - Early**

#### Early Dec - Command Bar NLP Backend ‚úÖ
**Session:** `d2b629e7-e46e-4451-9777-cfa2e10f1a3d`

**Objective:** Implement natural language processing for command bar

**Implementation:**
- Created `CommandController` with Regex-based intent parsing
- Natural language queries ‚Üí structured actions
- Navigation and message responses
- Integration with frontend command palette

---

## üîß Module Implementations

### 1. Nexus (Order Management Service)

**Core Entities:**
- `OrderEntity` - Complete order data with EAV support
- `AddressEntity` - Geocoded addresses with validation
- `AdditionalServiceEntity` - Value-added services per order

**Key Features:**
- Excel import/export (BMW template)
- EDI integration (BMW POD export)
- TES address validation
- Order verification workflow
- Status tracking & lifecycle management

**Recent Enhancements:**
- Address issue logging system
- Conflict detection and resolution
- Normalization failure tracking

---

### 2. Flux (Planning Service)

**Optimization Engine:**
- Timefold Solver integration
- Vehicle Routing Problem (VRP) solver
- Constraint configuration (time windows, capacity, skills)

**Entities:**
- `OptimizationSolutionEntity` - Optimization run metadata
- `RouteAssignmentEntity` - Persisted route assignments (NEW - Jan 2026)
- `OptimizationProfileEntity` - Solver configurations

**API Endpoints:**
- `/api/planning/optimization/solution` - Run optimizer
- `/api/planning/optimization/latest` - Get last solution
- `/api/planning/assignments/**` - Route assignment CRUD (NEW)

**Recent Additions (Jan 2026):**
- Route persistence layer
- Assignment management
- Driver/vehicle binding
- Magic link publishing

---

### 3. Ghost (Driver PWA)

**Architecture:**
- Offline-first with IndexedDB
- Service Worker for background sync
- Magic link authentication (24h expiry)

**Features:**
- Route viewing with map integration
- Stop-by-stop navigation
- Photo capture for POD
- Signature collection
- Offline mode with sync queue

---

### 4. IAM Service

**Authentication:**
- JWT tokens with 12h expiry
- Magic links for passwordless auth
- Role-based access control

**Entities:**
- `UserEntity` - Core user data
- `CustomerEntity` - Customer-specific profile
- `EmployeeEntity` - Employee-specific profile (department, job title)

**Recent Changes:**
- Added `legacyId` for migration mapping
- Customer/Employee entity separation
- Enhanced user profile management

---

### 5. Control Tower (Web UI)

**Views:**
- **Dashboard** - KPI tiles, real-time status
- **Orders** - List, create, edit, batch operations
- **Dispatch** - Map view, optimizer control, route assignments
- **Vehicles** - Fleet management
- **Drivers** - User management
- **Settings** - System configuration

**Recent Implementations:**
- Dispatch map with Deck.gl
- Route optimization workflow
- Assignment management modal
- "Send to Dispatch" workflow from Orders

---

## üéØ Key Technical Decisions

### 1. Event-Driven EAV Architecture
**Decision:** Use JSONB `properties` field for dynamic order attributes  
**Rationale:** Maximum flexibility for different customer requirements without schema migrations  
**Implementation:** `AssetInstance.properties` with JSON Schema validation

### 2. Offline-First PWA
**Decision:** IndexedDB + Service Workers for Ghost  
**Rationale:** Drivers work in areas with poor connectivity  
**Challenge:** Sync conflict resolution

### 3. Magic Links vs Passwords
**Decision:** Magic links for driver authentication  
**Rationale:** Simpler UX, no password management, time-limited security  
**Implementation:** UUID tokens with 24h expiry, stored in HashMap

### 4. Timefold for Optimization
**Decision:** Timefold Solver over custom algorithm  
**Rationale:** Industry-standard constraint solver, actively maintained  
**Configuration:** Easy Timefold, constraint streaming API

### 5. Microservices with Kafka
**Decision:** Event-driven communication via Kafka  
**Rationale:** Decoupling, scalability, audit trail  
**Topics:** `orders.created`, `orders.assigned`, `routes.planned`, `fleet.location.update`

### 6. JSONB for Route Data
**Decision:** Store complete routes in JSONB column  
**Rationale:** Flexible schema, queryable with PostgreSQL JSON operators  
**Performance:** Indexed for common queries

---

## üß™ Testing & Verification

### Manual E2E Tests

#### Route Optimization Flow
1. Login to Control Tower
2. Navigate to Orders
3. Select 3-5 orders
4. Click "Send to Dispatch"
5. Verify notification in Dispatch view
6. Select optimization profile
7. Run optimizer
8. Verify routes in ROUTES tab
9. Switch to ASSIGNMENTS tab
10. Verify persistence after page refresh

#### Assignment Management
1. Open Assignments tab
2. Click on route
3. Assign driver and vehicle
4. Change status to ASSIGNED
5. Save changes
6. Click Publish
7. Verify magic link generation

### Automated Tests
- Unit tests for optimization constraints
- Integration tests for API endpoints
- E2E tests with Playwright (planned)

---

## üìä Current Status (January 2026)

### Completed Modules
- ‚úÖ Nexus (Order Service) - 95% complete
- ‚úÖ Flux (Planning Service) - 90% complete (route persistence added)
- ‚úÖ IAM Service - 100% complete
- ‚úÖ Control Tower Web UI - 85% complete
- ‚úÖ Ghost (Driver PWA) - 70% complete (basic functionality)
- ‚ö†Ô∏è Titan (Fleet Management) - 60% complete (tracking works, needs enhancement)

### In Progress
- Assignment workflow refinement
- Driver/vehicle enrichment (mock ‚Üí real data from IAM/mesh)
- CORS fixes for `/profiles` endpoint
- WebSocket reconnection strategy

### Upcoming Features
- Real-time route updates via WebSocket
- Advanced constraint configuration UI
- Customer portal for order tracking
- Analytics dashboard
- Mobile app for customers

---

## üîó Quick Reference

### Important Files
- **Manifest:** `/Users/VoidTracker/PROJECT_MANAGEMENT/MANIFEST.md`
- **Main Task:** `/Users/VoidTracker/PROJECT_MANAGEMENT/task.md`
- **This Walkthrough:** `/Users/VoidTracker/PROJECT_MANAGEMENT/walkthrough-main.md`

### Key Services
- Control Tower: `http://localhost:3000`
- Order Service: `http://localhost:8091/api/orders`
- Planning Service: `http://localhost:8093/api/planning`
- IAM Service: `http://localhost:8081/api/auth`

### Startup
```bash
cd /Users/VoidTracker
./start-all.sh     # Start all services
./stop-all.sh      # Stop application services only
```

---

**Note:** This walkthrough consolidates 69 development sessions. For detailed session-specific information, refer to individual walkthrough files in `/Users/cruz/.gemini/antigravity/brain/{session-id}/walkthrough.md`

**Session Index Available:** Run `ls -lt /Users/cruz/.gemini/antigravity/brain/*/walkthrough*.md | head -20` for most recent sessions.
