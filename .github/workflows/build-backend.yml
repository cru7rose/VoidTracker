name: Build Backend Services

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'modules/**/*.java'
      - 'modules/**/pom.xml'
      - 'pom.xml'
      - '.github/workflows/build-backend.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'modules/**/*.java'
      - 'modules/**/pom.xml'
      - 'pom.xml'
  workflow_dispatch:

env:
  JAVA_VERSION: '21'
  MAVEN_OPTS: '-Xmx2048m'

jobs:
  build-all-services:
    name: Build All Backend Services
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Configure Maven settings
        run: |
          mkdir -p ~/.m2
          echo '<?xml version="1.0" encoding="UTF-8"?>
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                    http://maven.apache.org/xsd/settings-1.0.0.xsd">
            <localRepository>~/.m2/repository</localRepository>
          </settings>' > ~/.m2/settings.xml

      - name: Build all services from root
        run: |
          # Build all modules from root - Maven will handle dependencies automatically
          # This installs parent POM first, then builds all modules in correct order
          mvn clean install -DskipTests
          echo "âœ… All services built"

      - name: List built JARs
        run: |
          echo "ðŸ“¦ Built JAR files:"
          find modules -name "*.jar" -not -name "*-original.jar" -type f | head -30
          echo ""
          echo "ðŸ“Š JAR count:"
          find modules -name "*.jar" -not -name "*-original.jar" -type f | wc -l

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-jars
          path: |
            modules/**/target/*.jar
            !modules/**/target/*-original.jar
          retention-days: 7

      - name: Build Summary
        if: always()
        run: |
          echo "## ðŸ—ï¸ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          
          SERVICES=(
            "danxils-commons:modules/nexus/danxils-commons"
            "IAM Service:modules/nexus/iam-service"
            "Order Service:modules/nexus/order-service"
            "Planning Service:modules/flux/planning-service"
            "Tracking Service:modules/titan/tracking-service"
            "Event Emitter:modules/titan/event-emitter-service"
            "Analytics Service:modules/nexus/analytics-service"
            "Dashboard Service:modules/nexus/dashboard-service"
            "Admin Panel:modules/nexus/admin-panel-service"
            "Address Verification:modules/nexus/address-verification-service"
            "Driver App:modules/titan/driver-app-service"
            "Audit Service:modules/titan/audit-service"
            "CRM Service:modules/nexus/crm-service"
          )
          
          for service_info in "${SERVICES[@]}"; do
            IFS=':' read -r name path <<< "$service_info"
            if [ -f "$path/target"/*.jar ] && [ ! -f "$path/target"/*-original.jar ]; then
              echo "| $name | âœ… Built |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $name | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          done
