name: Build and Deploy Services

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'modules/**'
      - 'pom.xml'
      - '.github/workflows/build-and-deploy.yml'
  workflow_dispatch:
    inputs:
      services:
        description: 'Services to deploy (comma-separated: iam,order,planning)'
        required: false
        default: 'iam,order,planning'
      skip_tests:
        description: 'Skip tests'
        type: boolean
        default: true
      deploy:
        description: 'Deploy to server after build'
        type: boolean
        default: true

env:
  JAVA_VERSION: '21'
  MAVEN_OPTS: '-Xmx2g -XX:ActiveProcessorCount=2'

jobs:
  build-commons:
    name: Build danxils-commons
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Install parent POM
        run: |
          echo "ğŸ“¦ Installing parent POM (danxils-system)..."
          mvn install -N -DskipTests
          echo "âœ… Parent POM installed"

      - name: Build danxils-commons
        run: |
          echo "ğŸ“¦ Building danxils-commons..."
          # Build from root with -pl (project list) and -am (also make)
          mvn clean install -pl modules/nexus/danxils-commons -am -DskipTests -T 1C
          
          # Verify build success
          if [ ! -f "modules/nexus/danxils-commons/target/danxils-commons-1.0.0-SNAPSHOT.jar" ]; then
            echo "âŒ danxils-commons build failed - JAR not found"
            echo "ğŸ“‹ Files in target directory:"
            ls -la modules/nexus/danxils-commons/target/ || true
            exit 1
          fi
          echo "âœ… danxils-commons built successfully"

      - name: Upload danxils-commons artifact
        uses: actions/upload-artifact@v4
        with:
          name: danxils-commons
          path: modules/nexus/danxils-commons/target/*.jar
          retention-days: 7

  build:
    name: Build Services
    needs: build-commons
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        service:
          - name: iam
            module: modules/nexus/iam-service
            jar: iam-app-1.0.0-SNAPSHOT.jar
          - name: order
            module: modules/nexus/order-service
            jar: order-service-1.0.0-SNAPSHOT.jar
          - name: planning
            module: modules/flux/planning-service
            jar: planning-service-1.0.0-SNAPSHOT.jar
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Download danxils-commons
        uses: actions/download-artifact@v4
        with:
          name: danxils-commons
          path: modules/nexus/danxils-commons/target

      - name: Install danxils-commons to local Maven repo
        run: |
          echo "ğŸ“¦ Installing danxils-commons to local Maven repository..."
          
          # Find the JAR file
          JAR_FILE=$(find modules/nexus/danxils-commons/target -name "*.jar" -not -name "*-sources.jar" -not -name "*-javadoc.jar" | head -1)
          
          if [ -z "$JAR_FILE" ]; then
            echo "âŒ danxils-commons JAR not found"
            ls -la modules/nexus/danxils-commons/target/ || true
            exit 1
          fi
          
          echo "ğŸ“¦ Found JAR: $JAR_FILE"
          
          # Install to local Maven repo
          mvn install:install-file \
            -Dfile="$JAR_FILE" \
            -DgroupId=com.danxils \
            -DartifactId=danxils-commons \
            -Dversion=1.0.0-SNAPSHOT \
            -Dpackaging=jar \
            -DgeneratePom=true
          
          echo "âœ… danxils-commons installed to local Maven repo"

      - name: Build ${{ matrix.service.name }} Service
        id: build
        run: |
          cd ${{ matrix.service.module }}
          
          echo "ğŸ”¨ Building ${{ matrix.service.name }} Service..."
          echo "ğŸ“¦ Module: ${{ matrix.service.module }}"
          echo "ğŸ“¦ JAR: ${{ matrix.service.jar }}"
          
          # Build with error handling
          if [ "${{ github.event.inputs.skip_tests }}" = "true" ] || [ "${{ github.event_name }}" = "push" ]; then
            mvn clean package -DskipTests -T 1C -X 2>&1 | tee build.log || {
              echo "âŒ Build failed for ${{ matrix.service.name }}"
              echo "ğŸ“‹ Last 50 lines of build log:"
              tail -50 build.log
              exit 1
            }
          else
            mvn clean package -T 1C -X 2>&1 | tee build.log || {
              echo "âŒ Build failed for ${{ matrix.service.name }}"
              echo "ğŸ“‹ Last 50 lines of build log:"
              tail -50 build.log
              exit 1
            }
          fi
          
          # Verify JAR exists
          if [ ! -f "target/${{ matrix.service.jar }}" ]; then
            echo "âŒ JAR not found: target/${{ matrix.service.jar }}"
            echo "ğŸ“‹ Available files in target/:"
            ls -la target/ || true
            exit 1
          fi
          
          # Get JAR size
          JAR_SIZE=$(du -h "target/${{ matrix.service.jar }}" | cut -f1)
          echo "âœ… Built: ${{ matrix.service.jar }} ($JAR_SIZE)"

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service.name }}-jar
          path: ${{ matrix.service.module }}/target/${{ matrix.service.jar }}
          retention-days: 7

  deploy:
    name: Deploy to Server
    needs: build
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all JAR artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-jar'
          merge-multiple: false

      - name: Determine services to deploy
        id: services
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SERVICES="${{ github.event.inputs.services }}"
          else
            SERVICES="iam,order,planning"
          fi
          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Services to deploy: $SERVICES"

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}
        
      - name: Verify SSH Key
        run: |
          echo "ğŸ” Verifying SSH key..."
          if ssh-add -l > /dev/null 2>&1; then
            echo "âœ… SSH key loaded successfully"
            ssh-add -l
          else
            echo "âŒ Failed to load SSH key"
            echo "ğŸ’¡ Check if DEPLOY_SSH_KEY is correctly formatted in GitHub Secrets"
            exit 1
          fi

      - name: Test SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no \
              -p ${{ secrets.DEPLOY_SSH_PORT || '22' }} \
              ${{ secrets.DEPLOY_SSH_USER }}@${{ secrets.DEPLOY_SSH_HOST }} \
              "echo 'âœ… SSH connection successful'"

      - name: Create backup directory
        run: |
          ssh -o StrictHostKeyChecking=no \
              -p ${{ secrets.DEPLOY_SSH_PORT || '22' }} \
              ${{ secrets.DEPLOY_SSH_USER }}@${{ secrets.DEPLOY_SSH_HOST }} \
              "mkdir -p ${{ secrets.DEPLOY_REMOTE_BASE || '/root/VoidTracker' }}/.deploy-backups/$(date +%Y%m%d_%H%M%S)"

      - name: Deploy IAM Service
        if: contains(steps.services.outputs.services, 'iam')
        run: |
          REMOTE_BASE="${{ secrets.DEPLOY_REMOTE_BASE || '/root/VoidTracker' }}"
          REMOTE_DIR="$REMOTE_BASE/modules/nexus/iam-service/target"
          
          # Backup old JAR
          ssh -o StrictHostKeyChecking=no \
              -p ${{ secrets.DEPLOY_SSH_PORT || '22' }} \
              ${{ secrets.DEPLOY_SSH_USER }}@${{ secrets.DEPLOY_SSH_HOST }} \
              "mkdir -p $REMOTE_DIR && \
               if [ -f '$REMOTE_DIR/iam-app-1.0.0-SNAPSHOT.jar' ]; then \
                 cp '$REMOTE_DIR/iam-app-1.0.0-SNAPSHOT.jar' '$REMOTE_BASE/.deploy-backups/$(date +%Y%m%d_%H%M%S)/iam-app-1.0.0-SNAPSHOT.jar' 2>/dev/null || true; \
               fi"
          
          # Deploy new JAR
          scp -o StrictHostKeyChecking=no \
              -P ${{ secrets.DEPLOY_SSH_PORT || '22' }} \
              iam-jar/iam-app-1.0.0-SNAPSHOT.jar \
              ${{ secrets.DEPLOY_SSH_USER }}@${{ secrets.DEPLOY_SSH_HOST }}:$REMOTE_DIR/
          
          echo "âœ… IAM Service deployed"

      - name: Deploy Order Service
        if: contains(steps.services.outputs.services, 'order')
        run: |
          REMOTE_BASE="${{ secrets.DEPLOY_REMOTE_BASE || '/root/VoidTracker' }}"
          REMOTE_DIR="$REMOTE_BASE/modules/nexus/order-service/target"
          
          # Backup old JAR
          ssh -o StrictHostKeyChecking=no \
              -p ${{ secrets.DEPLOY_SSH_PORT || '22' }} \
              ${{ secrets.DEPLOY_SSH_USER }}@${{ secrets.DEPLOY_SSH_HOST }} \
              "mkdir -p $REMOTE_DIR && \
               if [ -f '$REMOTE_DIR/order-service-1.0.0-SNAPSHOT.jar' ]; then \
                 cp '$REMOTE_DIR/order-service-1.0.0-SNAPSHOT.jar' '$REMOTE_BASE/.deploy-backups/$(date +%Y%m%d_%H%M%S)/order-service-1.0.0-SNAPSHOT.jar' 2>/dev/null || true; \
               fi"
          
          # Deploy new JAR
          scp -o StrictHostKeyChecking=no \
              -P ${{ secrets.DEPLOY_SSH_PORT || '22' }} \
              order-jar/order-service-1.0.0-SNAPSHOT.jar \
              ${{ secrets.DEPLOY_SSH_USER }}@${{ secrets.DEPLOY_SSH_HOST }}:$REMOTE_DIR/
          
          echo "âœ… Order Service deployed"

      - name: Deploy Planning Service
        if: contains(steps.services.outputs.services, 'planning')
        run: |
          REMOTE_BASE="${{ secrets.DEPLOY_REMOTE_BASE || '/root/VoidTracker' }}"
          REMOTE_DIR="$REMOTE_BASE/modules/flux/planning-service/target"
          
          # Backup old JAR
          ssh -o StrictHostKeyChecking=no \
              -p ${{ secrets.DEPLOY_SSH_PORT || '22' }} \
              ${{ secrets.DEPLOY_SSH_USER }}@${{ secrets.DEPLOY_SSH_HOST }} \
              "mkdir -p $REMOTE_DIR && \
               if [ -f '$REMOTE_DIR/planning-service-1.0.0-SNAPSHOT.jar' ]; then \
                 cp '$REMOTE_DIR/planning-service-1.0.0-SNAPSHOT.jar' '$REMOTE_BASE/.deploy-backups/$(date +%Y%m%d_%H%M%S)/planning-service-1.0.0-SNAPSHOT.jar' 2>/dev/null || true; \
               fi"
          
          # Deploy new JAR
          scp -o StrictHostKeyChecking=no \
              -P ${{ secrets.DEPLOY_SSH_PORT || '22' }} \
              planning-jar/planning-service-1.0.0-SNAPSHOT.jar \
              ${{ secrets.DEPLOY_SSH_USER }}@${{ secrets.DEPLOY_SSH_HOST }}:$REMOTE_DIR/
          
          echo "âœ… Planning Service deployed"

      - name: Trigger Server Pull & Build
        if: success()
        run: |
          echo "ğŸ”„ Triggering pull & build on server..."
          
          # Try webhook first (if configured)
          if [ -n "${{ secrets.DEPLOY_WEBHOOK_URL }}" ]; then
            SERVICES="${{ steps.services.outputs.services }}"
            curl -X POST "${{ secrets.DEPLOY_WEBHOOK_URL }}?services=$SERVICES" \
              -H "X-GitHub-Event: workflow_run" \
              -H "X-GitHub-Delivery: ${{ github.run_id }}" \
              --max-time 30 \
              --silent --show-error || echo "âš ï¸  Webhook failed, using SSH fallback"
          fi
          
          # SSH fallback: trigger pull & build on server
          ssh -o StrictHostKeyChecking=no \
              -p ${{ secrets.DEPLOY_SSH_PORT || '22' }} \
              ${{ secrets.DEPLOY_SSH_USER }}@${{ secrets.DEPLOY_SSH_HOST }} \
              "cd ${{ secrets.DEPLOY_REMOTE_BASE || '/root/VoidTracker' }} && \
               ./scripts/git-sync-and-build.sh '${{ steps.services.outputs.services }}' || true" || \
          echo "âš ï¸  SSH trigger failed (server may pull manually)"

      - name: Restart Services on Server
        if: success()
        run: |
          echo "ğŸ”„ Restarting services on server..."
          REMOTE_BASE="${{ secrets.DEPLOY_REMOTE_BASE || '/root/VoidTracker' }}"
          SERVICES="${{ steps.services.outputs.services }}"
          
          # Restart each service
          IFS=',' read -ra SERVICE_ARRAY <<< "$SERVICES"
          for service in "${SERVICE_ARRAY[@]}"; do
            service=$(echo "$service" | xargs) # trim whitespace
            
            case "$service" in
              iam)
                echo "ğŸ”„ Restarting IAM Service..."
                ssh -o StrictHostKeyChecking=no \
                    -p ${{ secrets.DEPLOY_SSH_PORT || '22' }} \
                    ${{ secrets.DEPLOY_SSH_USER }}@${{ secrets.DEPLOY_SSH_HOST }} \
                    "cd $REMOTE_BASE && \
                     SKIP_BUILD=1 ./stop-iam.sh 2>/dev/null || true && \
                     sleep 2 && \
                     SKIP_BUILD=1 ./start-iam.sh" || echo "âš ï¸  Failed to restart IAM Service"
                ;;
              order)
                echo "ğŸ”„ Restarting Order Service..."
                ssh -o StrictHostKeyChecking=no \
                    -p ${{ secrets.DEPLOY_SSH_PORT || '22' }} \
                    ${{ secrets.DEPLOY_SSH_USER }}@${{ secrets.DEPLOY_SSH_HOST }} \
                    "cd $REMOTE_BASE && \
                     SKIP_BUILD=1 ./stop-order.sh 2>/dev/null || true && \
                     sleep 2 && \
                     SKIP_BUILD=1 ./start-order.sh" || echo "âš ï¸  Failed to restart Order Service"
                ;;
              planning)
                echo "ğŸ”„ Restarting Planning Service..."
                ssh -o StrictHostKeyChecking=no \
                    -p ${{ secrets.DEPLOY_SSH_PORT || '22' }} \
                    ${{ secrets.DEPLOY_SSH_USER }}@${{ secrets.DEPLOY_SSH_HOST }} \
                    "cd $REMOTE_BASE && \
                     SKIP_BUILD=1 ./stop-planning.sh 2>/dev/null || true && \
                     sleep 2 && \
                     SKIP_BUILD=1 ./start-planning.sh" || echo "âš ï¸  Failed to restart Planning Service"
                ;;
            esac
          done
          
          echo "âœ… Services restart initiated"

      - name: Verify Services Health
        if: success()
        run: |
          echo "ğŸ¥ Verifying services health..."
          REMOTE_BASE="${{ secrets.DEPLOY_REMOTE_BASE || '/root/VoidTracker' }}"
          SERVICES="${{ steps.services.outputs.services }}"
          
          sleep 10  # Wait for services to start
          
          # Check health endpoints
          IFS=',' read -ra SERVICE_ARRAY <<< "$SERVICES"
          for service in "${SERVICE_ARRAY[@]}"; do
            service=$(echo "$service" | xargs)
            
            case "$service" in
              iam)
                PORT="8090"
                ;;
              order)
                PORT="8091"
                ;;
              planning)
                PORT="8093"
                ;;
              *)
                continue
                ;;
            esac
            
            echo "ğŸ” Checking $service on port $PORT..."
            ssh -o StrictHostKeyChecking=no \
                -p ${{ secrets.DEPLOY_SSH_PORT || '22' }} \
                ${{ secrets.DEPLOY_SSH_USER }}@${{ secrets.DEPLOY_SSH_HOST }} \
                "curl -s -f http://localhost:$PORT/actuator/health > /dev/null && \
                 echo 'âœ… $service is healthy' || \
                 echo 'âš ï¸  $service health check failed'" || \
            echo "âš ï¸  Could not check $service health"
          done

      - name: Deployment Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   DEPLOYMENT COMPLETE âœ…                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¦ Services deployed: ${{ steps.services.outputs.services }}"
          echo "ğŸ”„ Services restarted automatically"
          echo ""
          echo "ğŸ”— View deployment logs:"
          echo "   https://github.com/cru7rose/VoidTracker/actions/runs/${{ github.run_id }}"
          echo ""
          echo "ğŸ’¡ Server logs:"
          echo "   ssh ${{ secrets.DEPLOY_SSH_USER }}@${{ secrets.DEPLOY_SSH_HOST }}"
          echo "   tail -f ${{ secrets.DEPLOY_REMOTE_BASE || '/root/VoidTracker' }}/logs/*.log"
