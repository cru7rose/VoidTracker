name: Build and Deploy Services

on:
  push:
    branches:
      - main
      - develop
    # paths:  # Temporarily disabled to allow all pushes to trigger
    #   - 'modules/**'
    #   - 'pom.xml'
    #   - '.github/workflows/build-and-deploy.yml'
  workflow_dispatch:
    inputs:
      services:
        description: 'Services to deploy (comma-separated: iam,order,planning)'
        required: false
        default: 'iam,order,planning'
      skip_tests:
        description: 'Skip tests'
        type: boolean
        default: true
      deploy:
        description: 'Deploy to server after build'
        type: boolean
        default: true

env:
  JAVA_VERSION: '21'
  MAVEN_OPTS: '-Xmx2g -XX:ActiveProcessorCount=2'

jobs:
  build-commons:
    name: Build danxils-commons
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Install parent POM
        run: |
          echo "ğŸ“¦ Installing parent POM (danxils-system)..."
          mvn install -N -DskipTests
          echo "âœ… Parent POM installed"

      - name: Build danxils-commons
        run: |
          echo "ğŸ“¦ Building danxils-commons..."
          mvn clean install -pl modules/nexus/danxils-commons -am -DskipTests -T 1C
          
          if [ ! -f "modules/nexus/danxils-commons/target/danxils-commons-1.0.0-SNAPSHOT.jar" ]; then
            echo "âŒ danxils-commons build failed - JAR not found"
            ls -la modules/nexus/danxils-commons/target/ || true
            exit 1
          fi
          echo "âœ… danxils-commons built successfully"

      - name: Upload danxils-commons artifact
        uses: actions/upload-artifact@v4
        with:
          name: danxils-commons
          path: modules/nexus/danxils-commons/target/*.jar
          retention-days: 7

  build-iam:
    name: Build IAM Service
    needs: build-commons
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Download danxils-commons
        uses: actions/download-artifact@v4
        with:
          name: danxils-commons
          path: modules/nexus/danxils-commons/target

      - name: Install danxils-commons
        run: |
          JAR_FILE=$(find modules/nexus/danxils-commons/target -name "*.jar" -not -name "*-sources.jar" -not -name "*-javadoc.jar" | head -1)
          if [ -z "$JAR_FILE" ]; then
            echo "âŒ danxils-commons JAR not found"
            exit 1
          fi
          mvn install:install-file \
            -Dfile="$JAR_FILE" \
            -DgroupId=com.danxils \
            -DartifactId=danxils-commons \
            -Dversion=1.0.0-SNAPSHOT \
            -Dpackaging=jar \
            -DgeneratePom=true

      - name: Build IAM Service
        run: |
          cd modules/nexus/iam-service
          mvn clean package -DskipTests -T 1C
          
          if [ ! -f "target/iam-app-1.0.0-SNAPSHOT.jar" ]; then
            echo "âŒ IAM Service build failed"
            exit 1
          fi
          JAR_SIZE=$(du -h "target/iam-app-1.0.0-SNAPSHOT.jar" | cut -f1)
          echo "âœ… Built: iam-app-1.0.0-SNAPSHOT.jar ($JAR_SIZE)"

      - name: Upload IAM JAR
        uses: actions/upload-artifact@v4
        with:
          name: iam-jar
          path: modules/nexus/iam-service/target/iam-app-1.0.0-SNAPSHOT.jar
          retention-days: 7

  build-order:
    name: Build Order Service
    needs: build-commons
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Download danxils-commons
        uses: actions/download-artifact@v4
        with:
          name: danxils-commons
          path: modules/nexus/danxils-commons/target

      - name: Install danxils-commons
        run: |
          JAR_FILE=$(find modules/nexus/danxils-commons/target -name "*.jar" -not -name "*-sources.jar" -not -name "*-javadoc.jar" | head -1)
          if [ -z "$JAR_FILE" ]; then
            echo "âŒ danxils-commons JAR not found"
            exit 1
          fi
          mvn install:install-file \
            -Dfile="$JAR_FILE" \
            -DgroupId=com.danxils \
            -DartifactId=danxils-commons \
            -Dversion=1.0.0-SNAPSHOT \
            -Dpackaging=jar \
            -DgeneratePom=true

      - name: Build Order Service
        run: |
          cd modules/nexus/order-service
          mvn clean package -DskipTests -T 1C
          
          if [ ! -f "target/order-service-1.0.0-SNAPSHOT.jar" ]; then
            echo "âŒ Order Service build failed"
            exit 1
          fi
          JAR_SIZE=$(du -h "target/order-service-1.0.0-SNAPSHOT.jar" | cut -f1)
          echo "âœ… Built: order-service-1.0.0-SNAPSHOT.jar ($JAR_SIZE)"

      - name: Upload Order JAR
        uses: actions/upload-artifact@v4
        with:
          name: order-jar
          path: modules/nexus/order-service/target/order-service-1.0.0-SNAPSHOT.jar
          retention-days: 7

  build-planning:
    name: Build Planning Service
    needs: build-commons
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Download danxils-commons
        uses: actions/download-artifact@v4
        with:
          name: danxils-commons
          path: modules/nexus/danxils-commons/target

      - name: Install danxils-commons
        run: |
          JAR_FILE=$(find modules/nexus/danxils-commons/target -name "*.jar" -not -name "*-sources.jar" -not -name "*-javadoc.jar" | head -1)
          if [ -z "$JAR_FILE" ]; then
            echo "âŒ danxils-commons JAR not found"
            exit 1
          fi
          mvn install:install-file \
            -Dfile="$JAR_FILE" \
            -DgroupId=com.danxils \
            -DartifactId=danxils-commons \
            -Dversion=1.0.0-SNAPSHOT \
            -Dpackaging=jar \
            -DgeneratePom=true

      - name: Build Planning Service
        run: |
          cd modules/flux/planning-service
          mvn clean package -DskipTests -T 1C
          
          if [ ! -f "target/planning-service-1.0.0-SNAPSHOT.jar" ]; then
            echo "âŒ Planning Service build failed"
            exit 1
          fi
          JAR_SIZE=$(du -h "target/planning-service-1.0.0-SNAPSHOT.jar" | cut -f1)
          echo "âœ… Built: planning-service-1.0.0-SNAPSHOT.jar ($JAR_SIZE)"

      - name: Upload Planning JAR
        uses: actions/upload-artifact@v4
        with:
          name: planning-jar
          path: modules/flux/planning-service/target/planning-service-1.0.0-SNAPSHOT.jar
          retention-days: 7

  deploy:
    name: Deploy to Server
    needs: [build-iam, build-order, build-planning]
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all JAR artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-jar'
          merge-multiple: false

      - name: Determine services to deploy
        id: services
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SERVICES="${{ github.event.inputs.services }}"
          else
            SERVICES="iam,order,planning"
          fi
          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Services to deploy: $SERVICES"

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}
        
      - name: Verify SSH Key
        run: |
          echo "ğŸ” Verifying SSH key..."
          if ssh-add -l > /dev/null 2>&1; then
            echo "âœ… SSH key loaded successfully"
            ssh-add -l
          else
            echo "âŒ Failed to load SSH key"
            exit 1
          fi

      - name: Test SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no \
              -p ${{ secrets.DEPLOY_SSH_PORT || '22' }} \
              ${{ secrets.DEPLOY_SSH_USER }}@${{ secrets.DEPLOY_SSH_HOST }} \
              "echo 'âœ… SSH connection successful'"

      - name: Deploy IAM Service
        if: contains(steps.services.outputs.services, 'iam')
        run: |
          REMOTE_BASE="${{ secrets.DEPLOY_REMOTE_BASE || '/root/VoidTracker' }}"
          REMOTE_DIR="$REMOTE_BASE/modules/nexus/iam-service/target"
          
          ssh -o StrictHostKeyChecking=no \
              -p ${{ secrets.DEPLOY_SSH_PORT || '22' }} \
              ${{ secrets.DEPLOY_SSH_USER }}@${{ secrets.DEPLOY_SSH_HOST }} \
              "mkdir -p $REMOTE_DIR"
          
          scp -o StrictHostKeyChecking=no \
              -P ${{ secrets.DEPLOY_SSH_PORT || '22' }} \
              iam-jar/iam-app-1.0.0-SNAPSHOT.jar \
              ${{ secrets.DEPLOY_SSH_USER }}@${{ secrets.DEPLOY_SSH_HOST }}:$REMOTE_DIR/
          
          echo "âœ… IAM Service deployed"

      - name: Deploy Order Service
        if: contains(steps.services.outputs.services, 'order')
        run: |
          REMOTE_BASE="${{ secrets.DEPLOY_REMOTE_BASE || '/root/VoidTracker' }}"
          REMOTE_DIR="$REMOTE_BASE/modules/nexus/order-service/target"
          
          ssh -o StrictHostKeyChecking=no \
              -p ${{ secrets.DEPLOY_SSH_PORT || '22' }} \
              ${{ secrets.DEPLOY_SSH_USER }}@${{ secrets.DEPLOY_SSH_HOST }} \
              "mkdir -p $REMOTE_DIR"
          
          scp -o StrictHostKeyChecking=no \
              -P ${{ secrets.DEPLOY_SSH_PORT || '22' }} \
              order-jar/order-service-1.0.0-SNAPSHOT.jar \
              ${{ secrets.DEPLOY_SSH_USER }}@${{ secrets.DEPLOY_SSH_HOST }}:$REMOTE_DIR/
          
          echo "âœ… Order Service deployed"

      - name: Deploy Planning Service
        if: contains(steps.services.outputs.services, 'planning')
        run: |
          REMOTE_BASE="${{ secrets.DEPLOY_REMOTE_BASE || '/root/VoidTracker' }}"
          REMOTE_DIR="$REMOTE_BASE/modules/flux/planning-service/target"
          
          ssh -o StrictHostKeyChecking=no \
              -p ${{ secrets.DEPLOY_SSH_PORT || '22' }} \
              ${{ secrets.DEPLOY_SSH_USER }}@${{ secrets.DEPLOY_SSH_HOST }} \
              "mkdir -p $REMOTE_DIR"
          
          scp -o StrictHostKeyChecking=no \
              -P ${{ secrets.DEPLOY_SSH_PORT || '22' }} \
              planning-jar/planning-service-1.0.0-SNAPSHOT.jar \
              ${{ secrets.DEPLOY_SSH_USER }}@${{ secrets.DEPLOY_SSH_HOST }}:$REMOTE_DIR/
          
          echo "âœ… Planning Service deployed"

      - name: Restart Services on Server
        if: success()
        run: |
          echo "ğŸ”„ Restarting services on server..."
          REMOTE_BASE="${{ secrets.DEPLOY_REMOTE_BASE || '/root/VoidTracker' }}"
          SERVICES="${{ steps.services.outputs.services }}"
          
          IFS=',' read -ra SERVICE_ARRAY <<< "$SERVICES"
          for service in "${SERVICE_ARRAY[@]}"; do
            service=$(echo "$service" | xargs)
            
            case "$service" in
              iam)
                echo "ğŸ”„ Restarting IAM Service..."
                ssh -o StrictHostKeyChecking=no \
                    -p ${{ secrets.DEPLOY_SSH_PORT || '22' }} \
                    ${{ secrets.DEPLOY_SSH_USER }}@${{ secrets.DEPLOY_SSH_HOST }} \
                    "cd $REMOTE_BASE && SKIP_BUILD=1 ./stop-iam.sh 2>/dev/null || true && sleep 2 && SKIP_BUILD=1 ./start-iam.sh" || echo "âš ï¸  Failed to restart IAM"
                ;;
              order)
                echo "ğŸ”„ Restarting Order Service..."
                ssh -o StrictHostKeyChecking=no \
                    -p ${{ secrets.DEPLOY_SSH_PORT || '22' }} \
                    ${{ secrets.DEPLOY_SSH_USER }}@${{ secrets.DEPLOY_SSH_HOST }} \
                    "cd $REMOTE_BASE && SKIP_BUILD=1 ./stop-order.sh 2>/dev/null || true && sleep 2 && SKIP_BUILD=1 ./start-order.sh" || echo "âš ï¸  Failed to restart Order"
                ;;
              planning)
                echo "ğŸ”„ Restarting Planning Service..."
                ssh -o StrictHostKeyChecking=no \
                    -p ${{ secrets.DEPLOY_SSH_PORT || '22' }} \
                    ${{ secrets.DEPLOY_SSH_USER }}@${{ secrets.DEPLOY_SSH_HOST }} \
                    "cd $REMOTE_BASE && SKIP_BUILD=1 ./stop-planning.sh 2>/dev/null || true && sleep 2 && SKIP_BUILD=1 ./start-planning.sh" || echo "âš ï¸  Failed to restart Planning"
                ;;
            esac
          done
          
          echo "âœ… Services restart initiated"

      - name: Restart Frontend on Server
        if: success()
        run: |
          echo "ğŸ”„ Restarting Frontend on server..."
          REMOTE_BASE="${{ secrets.DEPLOY_REMOTE_BASE || '/root/VoidTracker' }}"
          
          ssh -o StrictHostKeyChecking=no \
              -p ${{ secrets.DEPLOY_SSH_PORT || '22' }} \
              ${{ secrets.DEPLOY_SSH_USER }}@${{ secrets.DEPLOY_SSH_HOST }} \
              "cd $REMOTE_BASE && \
               ./stop-frontend.sh 2>/dev/null || true && \
               sleep 2 && \
               ./start-frontend.sh" || echo "âš ï¸  Failed to restart Frontend"
          
          echo "âœ… Frontend restart initiated"

      - name: Verify Services Health
        if: success()
        run: |
          echo "ğŸ¥ Verifying services health..."
          REMOTE_BASE="${{ secrets.DEPLOY_REMOTE_BASE || '/root/VoidTracker' }}"
          SERVICES="${{ steps.services.outputs.services }}"
          
          sleep 10
          
          IFS=',' read -ra SERVICE_ARRAY <<< "$SERVICES"
          for service in "${SERVICE_ARRAY[@]}"; do
            service=$(echo "$service" | xargs)
            
            case "$service" in
              iam)
                PORT="8090"
                ;;
              order)
                PORT="8091"
                ;;
              planning)
                PORT="8093"
                ;;
              *)
                continue
                ;;
            esac
            
            echo "ğŸ” Checking $service on port $PORT..."
            ssh -o StrictHostKeyChecking=no \
                -p ${{ secrets.DEPLOY_SSH_PORT || '22' }} \
                ${{ secrets.DEPLOY_SSH_USER }}@${{ secrets.DEPLOY_SSH_HOST }} \
                "curl -s -f http://localhost:$PORT/actuator/health > /dev/null && \
                 echo 'âœ… $service is healthy' || \
                 echo 'âš ï¸  $service health check failed'" || \
            echo "âš ï¸  Could not check $service health"
          done
          
          echo "ğŸ” Checking Frontend on port 5173..."
          ssh -o StrictHostKeyChecking=no \
              -p ${{ secrets.DEPLOY_SSH_PORT || '22' }} \
              ${{ secrets.DEPLOY_SSH_USER }}@${{ secrets.DEPLOY_SSH_HOST }} \
              "curl -s -f http://localhost:5173 > /dev/null && \
               echo 'âœ… Frontend is accessible' || \
               echo 'âš ï¸  Frontend health check failed'" || \
          echo "âš ï¸  Could not check Frontend health"

      - name: Deployment Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   DEPLOYMENT COMPLETE âœ…                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¦ Services deployed: ${{ steps.services.outputs.services }}"
          echo "ğŸ”„ Services restarted automatically"
          echo "ğŸ–¥ï¸  Frontend restarted automatically"
          echo ""
          echo "ğŸ”— View deployment logs:"
          echo "   https://github.com/cru7rose/VoidTracker/actions/runs/${{ github.run_id }}"
