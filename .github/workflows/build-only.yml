name: Build Only (No Deploy)

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'modules/**'
      - 'pom.xml'
  workflow_dispatch:

env:
  JAVA_VERSION: '21'
  MAVEN_OPTS: '-Xmx2g -XX:ActiveProcessorCount=2'

jobs:
  build:
    name: Build and Test Services
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        service:
          - name: iam
            module: modules/nexus/iam-service
            jar: iam-app-1.0.0-SNAPSHOT.jar
          - name: order
            module: modules/nexus/order-service
            jar: order-service-1.0.0-SNAPSHOT.jar
          - name: planning
            module: modules/flux/planning-service
            jar: planning-service-1.0.0-SNAPSHOT.jar
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Build danxils-commons (dependency)
        run: |
          cd modules/nexus/danxils-commons
          mvn clean install -DskipTests -T 1C

      - name: Build ${{ matrix.service.name }} Service
        run: |
          cd ${{ matrix.service.module }}
          mvn clean package -DskipTests -T 1C
          
          # Verify JAR exists
          if [ ! -f "target/${{ matrix.service.jar }}" ]; then
            echo "❌ JAR not found: target/${{ matrix.service.jar }}"
            exit 1
          fi
          
          # Get JAR size
          JAR_SIZE=$(du -h "target/${{ matrix.service.jar }}" | cut -f1)
          echo "✅ Built: ${{ matrix.service.jar }} ($JAR_SIZE)"

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service.name }}-jar
          path: ${{ matrix.service.module }}/target/${{ matrix.service.jar }}
          retention-days: 1
